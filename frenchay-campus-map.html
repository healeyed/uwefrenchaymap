<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWE Frenchay Campus Map Prototype - Cloud Style with GeoJSON</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        body { font-family: 'Inter', sans-serif; }

        /* Full-screen Modal Overlay */
        #map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* Modal Content Wrapper */
        .modal-content {
            background-color: #fff;
            width: 95%;
            height: 95%;
            max-width: 1400px;
            max-height: 900px;
            border-radius: 1rem;
            position: relative;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.4);
        }

        /* Map Container inside the modal */
        #map {
            height: 100%; /* Fill the entire modal content area */
            width: 100%;
            border-radius: 0.75rem; /* Slightly smaller radius inside the content box */
        }
        
        /* Style for the custom message box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002; /* Above the modal */
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 90%;
            text-align: center;
        }

        /* Style for the Legend overlay - positioned relative to the map (which is 100% of modal-content) */
        #map-legend {
            position: absolute;
            bottom: 16px; 
            left: 16px; 
            z-index: 4000; /* Increased z-index to clearly stack above the map canvas */
            /* grey with 90% opacity */
            background-color: rgba(140, 140, 140, 0.9); 
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            width: 220px;
        }

        /* Custom style for the POI selector */
        #poi-selector {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236B7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
    <script>
        let mapInstance; // Global variable to hold the map instance
        let buildingsLoaded = false;
        let mapInitialized = false; 
        let buildingFeatures = []; // Array to store {feature, marker} objects for easy filtering
        let hiddenCategories = new Map(); // Map to track currently hidden categories: { 'CategoryName': true }
        let infoWindow;
        const uweFrenchayLocation = { lat: 51.5015, lng: -2.549 }; // Central coordinates
        const CLOUD_MAP_ID = '9ba11c71e746911dd677c62b'; // Constant for the custom map style ID
        let isCustomMap = true; // State tracker for map type (Custom Roadmap vs Satellite)
        let poiMarker = null; // Global variable for the temporary POI marker

        // --- New: Lookup Data Structure for Points of Interest (POI) ---
        const pointOfInterestData = [
                                    {
                                        "name": "The Students' Union (U Block)",
                                        "lat": 51.50056787,
                                        "lng": -2.551535846,
                                        "details": "Main student services and social hub.",
                                        "floorId": 0
                                    },
                                    {
                                        "name": "Library",
                                        "lat": 51.50003517,
                                        "lng": -2.54846534,
                                        "details": "24/7 study space and book collection.",
                                        "floorId": 0
                                    },
                                    {
                                        "name": "2S526 S Block Room",
                                        "lat": 51.49749095,
                                        "lng": -2.54842925,
                                        "details": "S Block Mens Shower Room",
                                        "floorId": 2
                                    },
                                    {
                                        "name": "2S527 S Block Room",
                                        "lat": 51.49745444,
                                        "lng": -2.548492402,
                                        "details": "S Block Womens Shower Room",
                                        "floorId": 2
                                    },
                                    {
                                        "name": "3S505 S Block Room",
                                        "lat": 51.49749954,
                                        "lng": -2.548211297,
                                        "details": "S Block Level 3 ",
                                        "floorId": 3
                                    },
                                    {
                                        "name": "3S703 S Block Room",
                                        "lat": 51.49802319,
                                        "lng": -2.548618706,
                                        "details": "S Block Level 3 ",
                                        "floorId": 3
                                    },
                                    {
                                        "name": "4C001 C Block Room",
                                        "lat": 51.49938953,
                                        "lng": -2.548265932,
                                        "details": "C Block ITS Staff Hotdesk",
                                        "floorId": 4
                                    }
                                    ]

        // --- GeoJSON Data Structure ---
        const campusGeoJson = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Z",
                        "category": "Academic",
                        "details": "Enginnering facility.",
                        "color": "#387885" // Blue
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [
                            -2.550540184478848,
                            51.500425718057926
                            ],
                            [
                            -2.5505651998318797,
                            51.49990144833876
                            ],
                            [
                            -2.5496896624542273,
                            51.49987549423551
                            ],
                            [
                            -2.5497230162596907,
                            51.50000007379603
                            ],
                            [
                            -2.5497230162596907,
                            51.500342665830715
                            ],
                            [
                            -2.5499898466983666,
                            51.50035304736781
                            ],
                            [
                            -2.5499898466983666,
                            51.50040755039598
                            ],
                            [
                            -2.550540184478848,
                            51.500425718057926
                            ]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Sports & Leisure Center",
                        "category": "Recreation",
                        "details": "Gymnasium and courts.",
                        "color": "#10b981" // Green
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [
                            -2.5475854663576456,
                            51.50437929893985
                            ],
                            [
                            -2.5476517442903344,
                            51.50392156239033
                            ],
                            [
                            -2.547317198537428,
                            51.503897987851445
                            ],
                            [
                            -2.547295105892289,
                            51.50401782496513
                            ],
                            [
                            -2.5468406286426557,
                            51.50398835685155
                            ],
                            [
                            -2.54679644335377,
                            51.504334114849854
                            ],
                            [
                            -2.5475854663576456,
                            51.50437929893985
                            ]
                            ]]
                            }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Car Park 22",
                        "category": "Car Park",
                        "details": "Car Park 22",
                        "color": "#bd1aea", // Pink
                        "fill": "#bd1aea",
                        "fill-opacity": 0.5
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [
                            -2.553773927784448,
                            51.50359865505669
                            ],
                            [
                            -2.5528213338606918,
                            51.50316257709136
                            ],
                            [
                            -2.5522959121005044,
                            51.50370767389586
                            ],
                            [
                            -2.5523728030897814,
                            51.50380339754008
                            ],
                            [
                            -2.552757258035996,
                            51.50395495956451
                            ],
                            [
                            -2.5532314191378873,
                            51.50387519014089
                            ],
                            [
                            -2.553679949908826,
                            51.503726286842635
                            ],
                            [
                            -2.553773927784448,
                            51.50359865505669
                            ]
                            ]]
                            }
                },
                {
                    "type": "Feature",
                    "properties": {
                    "name": "Car Park 23",
                    "category": "Car Park",
                    "color": "#bd1aea", // Pink
                    },
                    "geometry": {
                    "coordinates": [
                        [
                        [
                            -2.551711199995509,
                            51.50399522684404
                        ],
                        [
                            -2.552170541181738,
                            51.50361541903163
                        ],
                        [
                            -2.5510804628448795,
                            51.503120383872385
                        ],
                        [
                            -2.5505731307894735,
                            51.50368796683591
                        ],
                        [
                            -2.550902211042626,
                            51.50383732959867
                        ],
                        [
                            -2.5513272730353833,
                            51.50396962192221
                        ],
                        [
                            -2.551711199995509,
                            51.50399522684404
                        ]
                        ]
                    ],
                    "type": "Polygon"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Purdown",
                        "category": "Accommodation",
                        "details": "Student accommodation complex.",
                        "color": "#facc15" // Yellow/Amber
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                        [
                        -2.5475565618100404,
                        51.50279604757614
                        ],
                        [
                        -2.5475222826179618,
                        51.50267655467496
                        ],
                        [
                        -2.547707390259461,
                        51.502168706348186
                        ],
                        [
                        -2.5479336329323132,
                        51.5015669627694
                        ],
                        [
                        -2.547851362869693,
                        51.50130236378752
                        ],
                        [
                        -2.5468572662739177,
                        51.501421860292
                        ],
                        [
                        -2.5469532480149724,
                        51.50168645858051
                        ],
                        [
                        -2.5471520673335704,
                        51.50166938776968
                        ],
                        [
                        -2.5471383556565,
                        51.501532821051796
                        ],
                        [
                        -2.5476388318739964,
                        51.501473072984
                        ],
                        [
                        -2.5475771293263563,
                        51.50182302483802
                        ],
                        [
                        -2.547433156716181,
                        51.50181448945892
                        ],
                        [
                        -2.547412589199837,
                        51.50189984317794
                        ],
                        [
                        -2.547549705972159,
                        51.5019254492623
                        ],
                        [
                        -2.5475017151016743,
                        51.50205774713663
                        ],
                        [
                        -2.547494859263793,
                        51.502283932935256
                        ],
                        [
                        -2.547275472428879,
                        51.50226686234819
                        ],
                        [
                        -2.5472617607517805,
                        51.50234367993997
                        ],
                        [
                        -2.547433156716181,
                        51.50237355341275
                        ],
                        [
                        -2.547330319137245,
                        51.50267228706559
                        ],
                        [
                        -2.547412589199837,
                        51.50282165315741
                        ],
                        [
                        -2.5475565618100404,
                        51.50279604757614
                        ]                        
                        ]]
                    }
                },
                {
                "type": "Feature",
                "properties": {
                "name": "Cotswold  ct",
                "category": "Accommodation",
                "description": "student accommodation ",
                "color": "#facc15" // Yellow/Amber
                },
                "geometry": {
                "coordinates": [
                        [
                        [
                        -2.5493185123274316,
                        51.50379465457337
                        ],
                        [
                        -2.549531043324521,
                        51.50272349835194
                        ],
                        [
                        -2.546247096639604,
                        51.50302649728698
                        ],
                        [
                        -2.5467544286949817,
                        51.503841597098926
                        ],
                        [
                        -2.5478170836762786,
                        51.50373490947098
                        ],
                        [
                        -2.548454676666182,
                        51.50363248911353
                        ],
                        [
                        -2.5489208736902356,
                        51.50361541903163
                        ],
                        [
                        -2.5493185123274316,
                        51.50379465457337
                        ]
                        ]
                        ],
                "type": "Polygon"
                }
                }
                ]
        };

        // Simple custom message box to replace alert()
        function showMessage(title, message) {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <div class="message-box border-t-4 border-indigo-500">
                    <h3 class="text-xl font-bold mb-2 text-gray-800">${title}</h3>
                    <p class="text-gray-600 mb-4">${message}</p>
                    <button onclick="closeMessage()" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                        Got it!
                    </button>
                </div>
            `;
            container.classList.remove('hidden');
        }

        function closeMessage() {
            document.getElementById('message-container').classList.add('hidden');
        }
        
        /**
         * Calculates the approximate center point of a GeoJSON Polygon feature.
         */
        function calculateApproximateCenter(geometry) {
            let latSum = 0;
            let lngSum = 0;
            let count = 0;

            // Coordinates are typically stored as a hierarchy of arrays
            const coordinates = geometry.getArray()[0].getArray();
            
            coordinates.forEach(point => {
                latSum += point.lat();
                lngSum += point.lng();
                count++;
            });

            return { lat: latSum / count, lng: lngSum / count };
        }

        /**
         * Styles a GeoJSON feature based on its properties.
         */
        function styleFeature(feature) {
            return {
                fillColor: feature.getProperty('color'),
                strokeWeight: 2,
                strokeColor: '#333333',
                fillOpacity: 0.5
            };
        }
        
        /**
         * Loads the GeoJSON data, applies default styling, creates labels (markers).
         */
        function loadBuildingData() {
            if (buildingsLoaded) return;

            // --- 1. Load GeoJSON Data ---
            mapInstance.data.addGeoJson(campusGeoJson);

            // --- 2. Set Default Styling and Markers ---
            mapInstance.data.setStyle(styleFeature);

            mapInstance.data.forEach(feature => {
                const center = calculateApproximateCenter(feature.getGeometry());
                const name = feature.getProperty('name');

                const marker = new google.maps.Marker({
                    position: center,
                    map: mapInstance,
                    label: {
                        text: name,
                        fontWeight: 'bold',
                        // Label text color is black
                        color: 'black', 
                        fontSize: '14px',
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0,
                    },
                });
                buildingFeatures.push({ feature, marker });
            });

            // --- 3. Add Interactivity (Hover & Click) ---
            infoWindow = new google.maps.InfoWindow();

            mapInstance.data.addListener('mouseover', (event) => {
                mapInstance.data.overrideStyle(event.feature, {
                    fillColor: '#ef4444',
                    strokeWeight: 4,
                    strokeColor: '#b91c1c',
                    fillOpacity: 0.9
                });
            });

            mapInstance.data.addListener('mouseout', (event) => {
                if (!hiddenCategories.has(event.feature.getProperty('category'))) {
                    mapInstance.data.revertStyle();
                }
            });

            mapInstance.data.addListener('click', (event) => {
                const name = event.feature.getProperty('name');
                const category = event.feature.getProperty('category');
                const details = event.feature.getProperty('details');
                
                // Get the coordinates for the navigation link from the click event
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                
                // Construct the Google Maps directions URL
                const navigationUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;

                infoWindow.setContent(`
                    <div class="p-1 max-w-xs">
                        <h4 class="text-md font-bold text-indigo-700">${name}</h4>
                        <p class="text-sm mt-1 text-gray-700"><strong>Category:</strong> ${category}</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>Details:</strong> ${details}</p>
                        
                        <!-- NAVIGATION LINK -->
                        <a href="${navigationUrl}" target="_blank" 
                           class="inline-flex items-center text-sm font-semibold text-white bg-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-700 transition duration-150 shadow-md">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 016.343 5.273L15.21 2.39a1 1 0 011.192.744l2.5 10a1 1 0 01-.744 1.192l-5.694 1.649z"/>
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18V6"/>
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12L8 12"/>
                           </svg>
                           Navigate to Here
                        </a>
                    </div>
                `);
                infoWindow.setPosition(event.latLng);
                infoWindow.open(mapInstance);
            });

            buildingsLoaded = true;
        }
        
        /**
         * Toggles visibility for a specific category based on the legend click.
         */
        function toggleCategoryVisibility(categoryName) {
            const safeCategoryName = categoryName.replace(/\s/g, '-');
            const legendItem = document.getElementById(`legend-${safeCategoryName}`);
            
            if (hiddenCategories.has(categoryName)) {
                // SHOW: Remove from hidden list and revert UI style
                hiddenCategories.delete(categoryName);
                legendItem.classList.remove('opacity-50', 'bg-gray-200');
            } else {
                // HIDE: Add to hidden list and update UI style
                hiddenCategories.set(categoryName, true);
                legendItem.classList.add('opacity-50', 'bg-gray-200');
            }

            // Apply filtering to GeoJSON and Markers
            buildingFeatures.forEach(obj => {
                const featureCategory = obj.feature.getProperty('category');
                
                if (featureCategory === categoryName) {
                    const isHidden = hiddenCategories.has(categoryName);
                    
                    // Toggle GeoJSON visibility
                    mapInstance.data.overrideStyle(obj.feature, { 
                        visible: !isHidden
                    });

                    // Toggle Marker (Label) visibility
                    obj.marker.setMap(isHidden ? null : mapInstance);
                }
            });
        }
        
        /**
         * Adds a fixed, custom-labeled marker for the East Entrance.
         */
        function addEastEntranceMarker() {
            const eastEntranceLocation = { lat: 51.5002, lng: -2.5442185630856793 };

            new google.maps.Marker({
                position: eastEntranceLocation,
                map: mapInstance,
                label: {
                    text: "East entrance",
                    fontWeight: 'bold',
                    // Label text color is black
                    color: 'black', 
                    fontSize: '16px',
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 0,
                },
            });
        }

        /**
         * Adds a directional arrow polyline near the East Entrance AND a label for Glenside Campus.
         */
        function addDirectionalArrow() {
            const arrowPath = [
                { lat: 51.49967621393417, lng: -2.543985706251763 },
                { lat: 51.499405716300075, lng: -2.543985706251763}
            ];

            // Marker position for the "To Glenside campus" label (slightly north of the arrow path start)
            const labelPosition = { lat: 51.49975, lng: -2.5441 }; 

            // Dark grey color for consistency with other custom labels
            const arrowColor = '#374151'; // Use this for the arrow itself

            const arrowHead = {
                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                scale: 5,
                strokeColor: arrowColor, 
                fillColor: arrowColor,
                fillOpacity: 1
            };

            new google.maps.Polyline({
                path: arrowPath,
                geodesic: true,
                strokeColor: arrowColor, 
                strokeOpacity: 1.0,
                strokeWeight: 4,
                map: mapInstance,
                icons: [{
                    icon: arrowHead,
                    offset: '100%'
                }]
            });

            // Add the text label "To Glenside campus"
            new google.maps.Marker({
                position: labelPosition,
                map: mapInstance,
                label: {
                    text: "To Glenside campus",
                    fontWeight: 'bold',
                    // Label text color is black
                    color: 'black', 
                    fontSize: '15px',
                },
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 0, // Hide the actual marker icon, only show the label
                },
            });
        }
        
        /**
         * Extracts unique categories and colors from GeoJSON data for the legend.
         */
        function getUniqueCategories() {
            const categories = new Map();
            campusGeoJson.features.forEach(feature => {
                const props = feature.properties;
                categories.set(props.category, props.color);
            });
            return Array.from(categories, ([category, color]) => ({ category, color }));
        }

        /**
         * Populates the custom HTML legend with data from unique categories.
         * Note: Legend text color remains white as per prior request.
         */
        function createLegend() {
            const legendDiv = document.getElementById('map-legend');
            const categories = getUniqueCategories();

            let html = `
                <div class="flex items-center space-x-2 mb-2 pb-1 border-b border-gray-300">
                    <!-- UWE Logo Image (40x40px using w-10 h-10 Tailwind classes) -->
                    <img src="https://style.uwe.ac.uk/branding/twentytwenty/engine/images/logo.svg" 
                         alt="UWE Bristol" 
                         class="w-10 h-10"/>
                    <!-- Legend title remains white -->
                    <h4 class="text-lg font-bold text-white">Frenchay Campus</h4>
                </div>
            `;
            html += '<ul class="space-y-1">';

            categories.forEach(item => {
                const safeCategoryName = item.category.replace(/\s/g, '-');
                html += `
                    <li id="legend-${safeCategoryName}" onclick="toggleCategoryVisibility('${item.category}')" 
                        class="legend-item flex items-center text-sm text-white cursor-pointer p-1 rounded transition duration-150 hover:bg-indigo-50 hover:shadow-sm">
                        <span class="inline-block w-4 h-4 rounded-sm mr-2" style="background-color: ${item.color}; border: 1px solid #333;"></span>
                        ${item.category}
                    </li>
                `;
            });

            html += '</ul>';
            legendDiv.innerHTML = html;
        }

        /**
         * Toggles between the custom cloud-styled map (Campus Style) and the default Google Maps satellite view.
         */
        window.toggleMapType = function() {
            if (!mapInstance) return;

            const button = document.getElementById('map-toggle-button');
            const options = {};
            
            if (isCustomMap) {
                // Switch to DEFAULT SATELLITE map
                options.mapId = undefined; // Use undefined for default maps
                options.mapTypeId = 'satellite'; 
                
                isCustomMap = false;
                if (button) button.innerHTML = 'Switch to <span class="font-bold">Campus Style</span>';
            } else {
                // Switch back to CUSTOM ROADMAP map
                options.mapId = CLOUD_MAP_ID; 
                options.mapTypeId = 'roadmap'; 

                isCustomMap = true;
                if (button) button.innerHTML = 'Switch to <span class="font-bold">Default Satellite</span>';
            }
            
            mapInstance.setOptions(options);
        }
        
        // --- POI Selection Logic ---

        /**
         * Populates the new select dropdown with POI data.
         */
        function populatePoiDropdown() {
            const select = document.getElementById('poi-selector');
            if (!select) return;

            // Clear previous options
            select.innerHTML = ''; 

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Find a place...";
            select.appendChild(defaultOption);

            // Add POI options
            pointOfInterestData.forEach(poi => {
                const option = document.createElement('option');
                // Encode data into the value field: lat|lng|name|details
                option.value = `${poi.lat}|${poi.lng}|${poi.name}|${poi.details}`;
                option.textContent = poi.name;
                select.appendChild(option);
            });
        }
        
        /**
         * Handles the selection of a point of interest from the dropdown.
         * @param {Event} event The change event from the select element.
         */
        window.handlePoiSelection = function(event) {
            const selectedValue = event.target.value;
            
            // Clear existing marker and InfoWindow if present
            if (poiMarker) {
                poiMarker.setMap(null);
                poiMarker = null;
                infoWindow.close();
            }
            
            if (selectedValue === "") {
                // If the user selects the default "Find a place..." option, just clear and return
                return;
            }

            // Decode data from the value field: lat|lng|name|details
            const parts = selectedValue.split('|');
            if (parts.length < 4) return;
            
            const [latStr, lngStr, name, details] = parts; 
            const lat = parseFloat(latStr); // Parse to float
            const lng = parseFloat(lngStr); // Parse to float
            const position = { lat: lat, lng: lng };
            
            // Construct the Google Maps directions URL
            const navigationUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;

            // Create a distinctive new marker
            poiMarker = new google.maps.Marker({
                position: position,
                map: mapInstance,
                title: name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#ef4444', // Red color for highlight
                    fillOpacity: 1,
                    strokeWeight: 0,
                    scale: 10,
                },
                animation: google.maps.Animation.DROP 
            });
            
            // Set map center and open info window
            mapInstance.setCenter(position);
            mapInstance.setZoom(18); // Zoom in closer

            infoWindow.setContent(`
                <div class="p-2 max-w-xs text-center">
                    <h4 class="text-lg font-extrabold text-red-700">${name}</h4>
                    <p class="text-sm mt-1 text-gray-700">${details}</p>
                    
                    <!-- New Navigation Button matching the red pin -->
                    <a href="${navigationUrl}" target="_blank" 
                       class="mt-3 inline-flex items-center text-sm font-semibold text-white bg-red-600 px-3 py-1 rounded-full hover:bg-red-700 transition duration-150 shadow-md">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 016.343 5.273L15.21 2.39a1 1 0 011.192.744l2.5 10a1 1 0 01-.744 1.192l-5.694 1.649z"/>
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18V6"/>
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12L8 12"/>
                       </svg>
                       Navigate to Here
                    </a>
                    
                    <p class="text-xs text-gray-500 mt-2">(Temporary Pin)</p>
                </div>
            `);
            infoWindow.open(mapInstance, poiMarker);
            
            // Add a click listener to the new marker to reopen the InfoWindow
            poiMarker.addListener('click', () => {
                infoWindow.open(mapInstance, poiMarker);
            });
        }

        // --- End of POI Selection Logic ---


        // Make initMap global so the dynamically loaded script can call it
        window.initMap = function() {
            
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                center: uweFrenchayLocation, 
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                mapId: CLOUD_MAP_ID, 
                mapTypeId: 'roadmap', 
            });

            mapInstance = map;
            
            loadBuildingData();
            addEastEntranceMarker();
            addDirectionalArrow();
            createLegend();
            populatePoiDropdown(); // <-- Call to populate the new dropdown
            
            // Set initial button text
            const mapButton = document.getElementById('map-toggle-button');
            if (mapButton) {
                mapButton.innerHTML = 'Switch to <span class="font-bold">Default Satellite</span>';
            }
        }
        
        /**
         * Dynamically loads the Google Maps script, which calls initMap on completion.
         */
        function loadGoogleMapsScript() {
            if (mapInitialized) return;

            const script = document.createElement('script');
            // Using a generic API key for the environment
            script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDu4eXL0Q1G18sogmpdvYUpNmez5v288q8&callback=initMap"; 
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            mapInitialized = true;
        }

        /**
         * Opens the modal and initializes the map if it hasn't been already.
         */
        function openMapModal() {
            const modal = document.getElementById('map-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (!mapInitialized) {
                // First time opening: load the script which calls initMap()
                loadGoogleMapsScript();
            } else {
                // Already initialized: ensure the map redraws correctly
                google.maps.event.trigger(mapInstance, 'resize');
                mapInstance.setCenter(uweFrenchayLocation);
            }
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            document.getElementById('map-modal').classList.remove('flex');
            document.getElementById('map-modal').classList.add('hidden');
        }

        /**
         * Handles clicks on the modal overlay to close it.
         * Only closes if the click target is the overlay itself, not content inside.
         */
        function handleModalClick(event) {
            if (event.target.id === 'map-modal') {
                closeModal();
            }
        }

        // --- Global Event Listeners for enhanced UX ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add listener for ESC key to close modal
            document.addEventListener('keydown', (e) => {
                const modal = document.getElementById('map-modal');
                if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        });
    </script>
</head>
<body class="bg-gray-100 p-6 sm:p-4">
    <div class="max-w-7xl mx-auto min-h-screen flex flex-col items-center justify-center">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">UWE Frenchay Campus Map Prototype</h1>
            <p class="text-lg text-gray-600">Click below to explore the interactive campus map.</p>
        </header>
        
        <!-- Map Open Button -->
        <button onclick="openMapModal()" class="px-8 py-3 bg-indigo-600 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.05] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
            🗺️ Open Interactive Campus Map
        </button>

        <!-- Map Modal (Initially Hidden) -->
        <div id="map-modal" class="hidden" onclick="handleModalClick(event)">
            <div class="modal-content">
                
                <!-- Control Group for POI Selector, Map Toggle, and Close Button -->
                <div class="absolute top-4 left-4 right-4 z-[5000] flex justify-between items-center space-x-4">
                    
                    <!-- Dropdown Container (Left Side) -->
                    <div class="flex-grow max-w-sm">
                        <label for="poi-selector" class="sr-only">Find a place</label>
                        <select id="poi-selector" onchange="handlePoiSelection(event)"
                            class="w-full px-4 py-2 bg-white text-gray-800 font-medium text-base rounded-full shadow-lg border-2 border-indigo-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 cursor-pointer">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    
                    <!-- Map Toggle and Close Buttons (Right Side) -->
                    <div class="flex items-center space-x-4">
                        <!-- Existing Map Type Toggle Button -->
                        <button id="map-toggle-button" onclick="toggleMapType()" 
                            class="px-3 py-2 bg-white text-indigo-700 font-semibold text-sm rounded-full shadow-lg hover:bg-indigo-50 transition duration-150">
                            Loading...
                        </button>
                        <!-- Close Button -->
                        <button onclick="closeModal()" class="p-2 rounded-full bg-white text-gray-800 hover:bg-red-100 shadow-xl transition duration-150 transform hover:scale-110">
                            <!-- Icon for close -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Map Container -->
                <div id="map"></div>
            
                <!-- Map Legend -->
                <div id="map-legend">
                    <!-- Content populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Message Container (hidden by default) -->
    <div id="message-container" class="hidden"></div>
</body>
</html>
